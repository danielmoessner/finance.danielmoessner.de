{% extends "layout/lm.j2" %}
{% set headingCategory = "Dashboard" %}
{% set headingHeading = "Banking" %}
{% set title = "Banking" %}
{% block main %}
    {% import "symbols/button.j2" as bg %}
    {% import "symbols/modal.j2" as mg %}
    <div class="d-flex justify-content-center mt-2 mb-5">
        <div class="btn-group" role="group" aria-label="Console">
            {{ bg.hrefButton("Stats", request.path + '?tab=stats', active=(tab=='stats') ) }}
            {{ bg.hrefButton("Accounts", request.path + '?tab=accounts', active=(tab=='accounts') ) }}
            {{ bg.hrefButton("Budgets", request.path + '?tab=budgets', active=(tab=='budgets') ) }}
            {{ bg.hrefButton("Categories", request.path + '?tab=categories', active=(tab=='categories') ) }}
            {{ bg.hrefButton("Statements", request.path + '?tab=statements', active=(tab=='statements') ) }}
            {{ bg.hrefButton("Charts", request.path + '?tab=charts', active=(tab=='charts') ) }}
        </div>
    </div>
    {% include 'symbols/stats.j2' %}
    {% if tab=='accounts' %}
        {{ mg.djangoModal('Add Change', 'addChange') }}
        {{ mg.djangoModal('Move Money', 'moveMoney') }}
        {{ mg.djangoModal('Edit Account', 'editAccount') }}
        {{ mg.djangoModal('Add Account', 'addAccount') }}
        {{ mg.djangoModal('Delete Account', 'deleteAccount') }}
        <table class="table rounded table-responsive-md table-dark mb-5">
            <thead>
                <tr>
                    <th scope="col">Account</th>
                    <th class="text-end" scope="col">Balance</th>
                    <th class="text-end" scope="col">{{ bg.modalButton("Move Money", "#moveMoney", url("banking:move_money") ) }}</th>
                </tr>
            </thead>
            <tbody>
                {% for account in accounts %}
                    <tr>
                        <td>
                            {{ account }}
                            {% if account.bucket %}
                                <span class="badge bg-success">{{ account.bucket.name }}</span>
                            {% else %}
                                {{ bg.modalButton("Set Bucket", "#editAccount", url("banking:edit_account", args=[account.pk]) ) }}
                            {% endif %}
                        </td>
                        <td class="text-end">{{ account.get_stats()['Balance'] }}</td>
                        <td>
                            <div class="d-flex align-items-center justify-content-end">
                                {{ bg.modalButton("Add Change", "#addChange", url("banking:add_change") +"?account="+account.pk|string) }}
                                {{ bg.modalButton("Edit", "#editAccount", url("banking:edit_account", args=[account.pk]) ) }}
                                {{ bg.hrefButton("Open", url("banking:account", args=[account.pk]) +"?tab=changes" ) }}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="2">
                        <div class="d-flex">
                            {{ bg.modalButton("Add Account", "#addAccount", url("banking:add_account") ) }}
                            {{ bg.modalButton("Delete Account", "#deleteAccount", url("banking:delete_account") ) }}
                        </div>
                    </td>
                    <td class="text-end">
                        <a class="btn btn-sm btn-link text-secondary"
                           href="{{ url("banking:index") }}?tab=accounts&show_archived=1">Include Archived</a>
                    </td>
                </tr>
            </tbody>
        </table>
    {% endif %}
    {% if tab=='budgets' %}
        <div class="overflow-x-auto mb-5">
            <table class="mb-0 table table-dark rounded">
                <thead>
                    <tr>
                        <th scope="col" class="">Category</th>
                        {% for dt in months %}
                            <th class="text-end px-1" style="white-space: nowrap;" scope="col">{{ dt.strftime("%b %y") }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for category in categories %}
                        <tr>
                            <td>{{ category.name }} {{ category.monthly_budget_str }}</td>
                            {% for dt in months %}<td class="text-end" scope="col">{{ category.get_month(dt) }}</td>{% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
    {% if tab=='statements' %}
        <div class="overflow-x-auto mb-5">
            <table class="mb-0 table table-dark rounded">
                <thead>
                    <tr>
                        <th scope="col" class="">Category</th>
                        {% for month in statements.months %}
                            <th class="text-end px-1" style="white-space: nowrap;" scope="col">{{ month }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for category, values in statements.data.items() %}
                        <tr>
                            <td>
                                <input type="checkbox"
                                       class="form-check-input me-2 category-checkbox"
                                       id="category-{{ loop.index }}"
                                       {% if not request.session.banking or not request.session.banking.selected_statement_categories %}checked{% elif category in request.session.banking.selected_statement_categories %}checked{% endif %}>
                                <label for="category-{{ loop.index }}">{{ category }}</label>
                            </td>
                            {% for v in values %}
                                <td class="text-end category-value" data-value="{{ v }}" scope="col">{{ "%.2f"|format(v) }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    <tr class="">
                        <td>
                            <strong>Total</strong>
                        </td>
                        {% for month in statements.months %}<td class="text-end total-cell" data-month="{{ loop.index0 }}"></td>{% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <script>
            const checkboxes = document.querySelectorAll('.category-checkbox');
            const totalCells = document.querySelectorAll('.total-cell');
            
            
            function updateTotals() {
                totalCells.forEach(cell => {
                    cell.innerHTML = '<strong>0.00</strong>';
                });
                
                const selectedCategories = [];

                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        const label = checkbox.nextElementSibling.textContent.trim();
                        selectedCategories.push(label);

                        const row = checkbox.closest('tr');
                        const valueCells = row.querySelectorAll('.category-value');
                        
                        valueCells.forEach((cell, index) => {
                            const value = parseFloat(cell.dataset.value) || 0;
                            const currentTotal = parseFloat(totalCells[index].textContent) || 0;
                            const newTotal = currentTotal + value;
                            totalCells[index].innerHTML = `<strong>${newTotal.toFixed(2)}</strong>`;
                        });
                    }
                });
           
                const selectedValue = selectedCategories.join('|');
                const encoded = encodeURIComponent(selectedValue);
                const baseUrl = `{{ url('banking:store', args=['selected_statement_categories', 'PLACEHOLDER']) }}`;
                const finalUrl = baseUrl.replace('PLACEHOLDER', encoded);
                fetch(finalUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json',
                    },
                });
            }
            
            updateTotals();
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateTotals);
            });
        </script>
    {% endif %}
    {% if tab=='categories' %}
        <table class="table rounded table-responsive-md table-dark mb-5">
            <thead>
                <tr>
                    <th scope="col">Category</th>
                    {% for year in years %}
                        <th class="text-end" scope="col">{{ year }}</th>
                    {% endfor %}
                    <th scope="col"></th>
                </tr>
            </thead>
            <tbody>
                {% for category in categories %}
                    <tr>
                        <td>{{ category.name }}</td>
                        {% for year in years %}
                            <td class="text-end" scope="col">{{ category.get_stats().get(year, "0.00 â‚¬") }}</td>
                        {% endfor %}
                        <td>
                            <div class="d-flex justify-content-end">
                                {{ bg.modalButton("Edit", "#editCategory", url("banking:edit_category", args=[category.pk]) ) }}
                                {{ mg.djangoModal('Edit Category', 'editCategory') }}
                                {{ bg.hrefButton("Open", url("banking:category", args=[category.pk]) ) }}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="{{ years|length + 2 }}">
                        <div class="d-flex">
                            {{ mg.djangoModal('Add Category', 'addCategory') }}
                            {{ bg.modalButton('Add Category', '#addCategory', url("banking:add_category") ) }}
                            {{ mg.djangoModal('Delete Category', 'deleteCategory') }}
                            {{ bg.modalButton('Delete Category', '#deleteCategory', url("banking:delete_category") ) }}
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    {% endif %}
    {% if tab=='charts' %}
        {% include 'banking/symbols/balance_chart.html' %}
        {% include 'banking/symbols/income_and_expenditure_chart.html' %}
    {% endif %}
{% endblock %}
